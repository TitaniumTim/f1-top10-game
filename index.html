<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>F1 Top 10 – Live</title>
<style>
body{margin:0;font-family:system-ui;background:#0f0f14;color:#fff}
header{padding:16px;background:#e10600;font-weight:700;text-align:center}
.container{padding:16px;max-width:1200px;margin:auto}
.card{background:#1c1c26;border-radius:8px;padding:16px;margin-bottom:16px}
h2{margin-top:0}
button{padding:10px 14px;background:#e10600;border:none;border-radius:6px;color:#fff;font-weight:600;cursor:pointer}
select{padding:8px;border-radius:6px;border:none;background:#222;color:#fff;margin-right:8px}

/* Stage styles (keep your previous polished CSS here) */
.grid{display:grid;gap:8px;margin-bottom:16px}
.counter{margin-bottom:10px;font-weight:600}
/* TEAM BUTTON */
.team-btn{position:relative;padding:12px;border-radius:6px;text-align:center;font-weight:600;cursor:pointer}
.team-btn.selected::after{
  content:"✔";
  position:absolute;top:6px;right:8px;background:#000;color:#fff;border-radius:50%;
  font-size:12px;padding:2px 6px;
}
/* ENTRANTS */
.entrants{font-size:.85rem;margin-top:6px;opacity:.9}
/* Stage 2 */
.stage2-row{display:grid;grid-template-columns:200px 40px 120px 40px 200px;align-items:center;gap:10px;margin-bottom:10px}
.switch{width:60px;height:28px;background:#444;border-radius:20px;position:relative;cursor:pointer}
.switch::after{content:"";position:absolute;width:24px;height:24px;background:#fff;border-radius:50%;top:2px;left:2px;transition:.2s}
.switch.active{background:#e10600}
.switch.active::after{left:34px}
/* Stage 3 */
.driver-row{display:grid;grid-template-columns:200px 1fr 1fr;gap:8px;margin-bottom:8px}
.driver{padding:10px;border-radius:6px;text-align:center;cursor:pointer;font-weight:600}
.driver.selected{outline:3px solid #fff}
/* Stage 4 */
.stage4-layout{display:grid;grid-template-columns:40px 1fr;gap:12px}
.position-col{display:grid;grid-template-rows:repeat(10,50px);gap:6px}
.guess-col{display:grid;grid-template-rows:repeat(10,50px);gap:6px}
.guess-slot{background:#2a2a38;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.75rem}
.guess-slot.correct{background:#00b200}
.guess-slot.wrong{background:#b20000}
.pool{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.locked{opacity:.5}
</style>
</head>
<body>
<header>F1 TOP 10 – Live</header>
<div class="container">

<!-- SESSION SELECT -->
<div class="card" id="session-screen">
<h2>Select Session</h2>
<select id="year-select"><option>Loading...</option></select>
<select id="round-select"><option>Loading...</option></select>
<select id="session-select"><option>Loading...</option></select>
<button id="start-game-btn">Start Game</button>
</div>

<!-- Stage 1 -->
<div class="card" id="stage1" style="display:none">
<h2>Stage 1 – Select Teams</h2>
<div class="counter">Selected: <span id="team-count">0</span>/6</div>
<div class="grid" id="team-grid" style="grid-template-columns:repeat(auto-fill,minmax(140px,1fr));"></div>
<button onclick="submitStage1()">Submit Guess</button>
</div>

<!-- Stage 2 -->
<div class="card" id="stage2" style="display:none">
<h2>Stage 2 – Cars per Team</h2>
<div class="counter">Total Cars: <span id="car-total">0</span>/10</div>
<div id="stage2-container"></div>
<button onclick="submitStage2()">Continue</button>
</div>

<!-- Stage 3 -->
<div class="card" id="stage3" style="display:none">
<h2>Stage 3 – Single Driver Teams</h2>
<p id="stage3-message"></p>
<div id="stage3-container"></div>
<button onclick="submitStage3()">Continue</button>
</div>

<!-- Stage 4 -->
<div class="card" id="stage4" style="display:none">
<h2>Stage 4 – Order the Top 10</h2>
<div class="pool" id="driver-pool"></div>
<div class="stage4-layout">
<div class="position-col" id="position-col"></div>
<div class="guess-col" id="guess-col"></div>
</div>
<button onclick="submitGuess()">Submit Guess</button>
</div>

</div>

<script>
// ------------------- Dynamic session dropdowns -------------------
async function fetchYears() {
  const res = await fetch('/api/years');
  const years = await res.json();
  const yearSelect = document.getElementById('year-select');
  yearSelect.innerHTML = '';
  years.forEach(y => {
    const opt = document.createElement('option'); opt.value=y; opt.textContent=y;
    yearSelect.appendChild(opt);
  });
  fetchRounds();
}

async function fetchRounds() {
  const year = document.getElementById('year-select').value;
  const res = await fetch(`/api/rounds?year=${year}`);
  const rounds = await res.json();
  const roundSelect = document.getElementById('round-select');
  roundSelect.innerHTML='';
  rounds.forEach(r => {
    const opt=document.createElement('option'); opt.value=r.number; opt.textContent=r.name;
    roundSelect.appendChild(opt);
  });
  fetchSessions();
}

async function fetchSessions() {
  const year=document.getElementById('year-select').value;
  const round=document.getElementById('round-select').value;
  const res=await fetch(`/api/sessions?year=${year}&round=${round}`);
  const sessions=await res.json();
  const sessionSelect=document.getElementById('session-select');
  sessionSelect.innerHTML='';
  sessions.forEach(s=>{
    const opt=document.createElement('option'); opt.value=s; opt.textContent=s;
    sessionSelect.appendChild(opt);
  });
}

// Update rounds & sessions when year/round changes
document.getElementById('year-select').addEventListener('change',fetchRounds);
document.getElementById('round-select').addEventListener('change',fetchSessions);

document.getElementById('start-game-btn').addEventListener('click',async()=>{
  const year=document.getElementById('year-select').value;
  const round=document.getElementById('round-select').value;
  const session=document.getElementById('session-select').value;
  // Fetch top 10 from backend
  const res=await fetch(`/api/session?year=${year}&round=${round}&session=${session}`);
  const data=await res.json();
  window.top10=data.top10.map(d=>({driver:d.driver,team:d.team,number:d.number}));
  startGame();
});

fetchYears();

// ------------------- Existing Stage Logic -------------------
// Keep all your Stage 1-4 functions here, just replace 'correctOrder' array with:
// const correctOrder = window.top10.map(d => d.driver);

</script>
</body>
</html>
