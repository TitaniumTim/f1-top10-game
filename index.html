<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>F1 Top 10 Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
      padding: 20px;
    }

    select, button {
      padding: 8px;
      margin: 5px 0;
    }

    .hidden {
      display: none;
    }

    #gameArea {
      margin-top: 20px;
    }

    input {
      padding: 6px;
      width: 300px;
    }
  </style>
</head>
<body>

<h1>F1 Top 10 Prediction Game</h1>

<!-- Dropdowns -->
<label>Year:</label><br>
<select id="yearSelect">
  <option>Loading...</option>
</select><br>

<label>Round:</label><br>
<select id="roundSelect" disabled>
  <option>Select year first</option>
</select><br>

<label>Session:</label><br>
<select id="sessionSelect" disabled>
  <option>Select round first</option>
</select><br>

<button id="startBtn" disabled>Start Game</button>

<!-- Game Area -->
<div id="gameArea" class="hidden">
  <h2>Predict Top 10</h2>
  <p>Enter driver surnames separated by commas:</p>
  <input type="text" id="predictionInput" placeholder="e.g. Verstappen, Norris, Hamilton..." />
  <br><br>
  <button id="submitBtn">Submit Prediction</button>

  <div id="resultsArea"></div>
</div>

<script>
const yearSelect = document.getElementById("yearSelect");
const roundSelect = document.getElementById("roundSelect");
const sessionSelect = document.getElementById("sessionSelect");
const startBtn = document.getElementById("startBtn");
const gameArea = document.getElementById("gameArea");
const submitBtn = document.getElementById("submitBtn");
const resultsArea = document.getElementById("resultsArea");

let actualTop10 = [];

// Load Years
async function loadYears() {
  const res = await fetch("/api/years");
  const years = await res.json();

  yearSelect.innerHTML = "<option>Select year</option>";
  years.forEach(y => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    yearSelect.appendChild(opt);
  });
}

yearSelect.addEventListener("change", async () => {
  const year = yearSelect.value;
  roundSelect.disabled = true;
  sessionSelect.disabled = true;
  startBtn.disabled = true;

  const res = await fetch(`/api/rounds?year=${year}`);
  const rounds = await res.json();

  roundSelect.innerHTML = "<option>Select round</option>";
  rounds.forEach(r => {
    const opt = document.createElement("option");
    opt.value = r.number;
    opt.textContent = `Round ${r.number} - ${r.name}`;
    roundSelect.appendChild(opt);
  });

  roundSelect.disabled = false;
});

roundSelect.addEventListener("change", async () => {
  const year = yearSelect.value;
  const round = roundSelect.value;

  sessionSelect.disabled = true;
  startBtn.disabled = true;

  const res = await fetch(`/api/sessions?year=${year}&round=${round}`);
  const sessions = await res.json();

  sessionSelect.innerHTML = "<option>Select session</option>";
  sessions.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s.toUpperCase();
    sessionSelect.appendChild(opt);
  });

  sessionSelect.disabled = false;
});

sessionSelect.addEventListener("change", () => {
  startBtn.disabled = false;
});

startBtn.addEventListener("click", async () => {
  const year = yearSelect.value;
  const round = roundSelect.value;
  const session = sessionSelect.value;

  const res = await fetch(`/api/session?year=${year}&round=${round}&session=${session}`);
  const data = await res.json();

  actualTop10 = data.top10.map(d =>
    d.driver.split(" ").slice(-1)[0].toLowerCase()
  );

  gameArea.classList.remove("hidden");
  resultsArea.innerHTML = "";
});

submitBtn.addEventListener("click", () => {
  const userInput = document.getElementById("predictionInput").value;
  const predictions = userInput
    .split(",")
    .map(p => p.trim().toLowerCase())
    .slice(0, 10);

  let score = 0;

  predictions.forEach((p, i) => {
    if (p === actualTop10[i]) score++;
  });

  resultsArea.innerHTML = `
    <h3>Results</h3>
    <p>Your Score: ${score} / 10</p>
    <p><strong>Actual Top 10:</strong> ${actualTop10.join(", ")}</p>
  `;
});

// Initial load
loadYears();
</script>

</body>
</html>
